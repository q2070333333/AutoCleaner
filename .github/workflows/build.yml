# iOS 16 插件保姆级云编译教程

请严格按照以下步骤操作，不要跳步。

## 第一阶段：注册与创建仓库

1. 打开浏览器，访问 [**https://github.com**](https://github.com)。

2. 如果你没有账号，点击右上角 **Sign up** 注册一个（需要邮箱验证）。如果你有，直接 **Sign in** 登录。

3. 登录后，点击页面右上角的 **+** 号，选择 **New repository** (新建仓库)。

4. 在 **Repository name** (仓库名称) 输入框里填：`AutoCleaner`。

5. 确保选中 **Public** (公开)。

6. 点击页面最底下的绿色按钮 **Create repository**。

## 第二阶段：复制粘贴代码 (最关键！)

我们需要创建 **4个文件**。请按照顺序，一个一个来。

### 第 1 个文件：云编译配置 (最重要)

1. 在刚才创建好的仓库页面，点击 **Add file** 按钮，选择 **Create new file**。

2. **仔细看！** 在文件名输入框（显示 Name your file... 的地方），**直接复制粘贴**下面这行字：
   `.github/workflows/build.yml`
   *(注意：一旦你粘贴进去，GitHub 会自动把它变成文件夹的形式，这是正常的)*

3. 在下面的大文本框里，**完全复制**以下代码，不要漏掉任何一行：

```yaml
name: Build Tweak

on: [push]

jobs:
  build:
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v3

      - name: Install Theos
        run: |
          bash -c "$(curl -fsSL [https://raw.githubusercontent.com/theos/theos/master/bin/install-theos](https://raw.githubusercontent.com/theos/theos/master/bin/install-theos))"
          echo "THEOS=~/theos" >> $GITHUB_ENV

      - name: Download iOS SDK
        run: |
          curl -LO [https://github.com/theos/sdks/archive/master.zip](https://github.com/theos/sdks/archive/master.zip)
          unzip master.zip
          mkdir -p ~/theos/sdks
          mv sdks-master/*.sdk ~/theos/sdks/
          rm -r sdks-master master.zip

      - name: Build Package
        run: |
          make package FINALPACKAGE=1 MESSAGES=0

      - name: Upload Deb
        uses: actions/upload-artifact@v3
        with:
          name: AutoCleaner-Deb
          path: packages/*.deb
```

4. 点击页面右上角的绿色按钮 **Commit changes...**，再点一次弹窗里的 **Commit changes**。

### 第 2 个文件：插件信息 (control)

1. 文件提交后，你会回到文件列表。再次点击 **Add file** -> **Create new file**。

2. 文件名输入：`control` (全小写，没有后缀)。

3. 内容复制下面这段：

```text
Package: com.user.autocleaner
Name: AutoCleaner
Depends: mobilesubstrate
Version: 0.0.1
Architecture: iphoneos-arm
Description: iOS 16 Cleaner Button
Maintainer: Me
Author: Me
Section: Tweaks
```

4. 点击 **Commit changes...** 保存。

### 第 3 个文件：编译规则 (Makefile)

1. 再次点击 **Add file** -> **Create new file**。

2. 文件名输入：`Makefile` (注意 M 大写，没有后缀)。

3. 内容复制下面这段：

```makefile
TARGET := iphone:clang:latest:16.0
INSTALL_TARGET_PROCESSES = SpringBoard

include $(THEOS)/makefiles/common.mk

TWEAK_NAME = AutoCleaner

AutoCleaner_FILES = Tweak.x
AutoCleaner_CFLAGS = -fobjc-arc
AutoCleaner_FRAMEWORKS = UIKit

include $(THEOS_MAKE_PATH)/tweak.mk
```

4. 点击 **Commit changes...** 保存。

### 第 4 个文件：核心功能代码 (Tweak.x)

1. 最后一次点击 **Add file** -> **Create new file**。

2. 文件名输入：`Tweak.x` (注意 T 大写，后缀是 .x)。

3. 内容复制下面这段（这是根据你的要求定制的功能）：

```objectivec
#import <UIKit/UIKit.h>
#import <spawn.h>

// 声明外部变量
extern char **environ;

// 执行命令的工具函数
void run_cmd(const char *cmd) {
    pid_t pid;
    const char *argv[] = {"sh", "-c", cmd, NULL};
    int status;
    posix_spawn(&pid, "/bin/sh", NULL, NULL, (char* const*)argv, environ);
    waitpid(pid, &status, 0);
}

// 弹窗提示
void show_alert(NSString *msg) {
    dispatch_async(dispatch_get_main_queue(), ^{
        UIWindow *keyWindow = [UIApplication sharedApplication].keyWindow;
        UIViewController *rootVC = keyWindow.rootViewController;
        if (rootVC) {
             UIAlertController *alert = [UIAlertController alertControllerWithTitle:@"AutoCleaner" message:msg preferredStyle:UIAlertControllerStyleAlert];
             [alert addAction:[UIAlertAction actionWithTitle:@"OK" style:UIAlertActionStyleDefault handler:nil]];
             [rootVC presentViewController:alert animated:YES completion:nil];
        }
    });
}

// 悬浮按钮类
@interface FloatyButton : UIButton
@end

@implementation FloatyButton
- (instancetype)initWithFrame:(CGRect)frame {
    self = [super initWithFrame:frame];
    if (self) {
        self.backgroundColor = [UIColor colorWithRed:0.0 green:0.5 blue:1.0 alpha:0.8]; // 蓝色半透明
        self.layer.cornerRadius = frame.size.width / 2;
        self.layer.masksToBounds = YES;
        [self setTitle:@"清" forState:UIControlStateNormal];
        
        // 点击事件
        [self addTarget:self action:@selector(handleTap) forControlEvents:UIControlEventTouchUpInside];
        
        // 拖拽手势
        UIPanGestureRecognizer *pan = [[UIPanGestureRecognizer alloc] initWithTarget:self action:@selector(handlePan:)];
        [self addGestureRecognizer:pan];
    }
    return self;
}

- (void)handleTap {
    // 1. 杀掉Filza
    run_cmd("killall Filza");
    
    // 2. 清理缓存 (对应你的图3路径)
    run_cmd("rm -rf /var/mobile/Library/Caches/*");
    run_cmd("rm -rf /var/mobile/Library/Cookies/*");
    run_cmd("rm -rf /var/mobile/Library/SplashBoard/*");
    // 这里添加更多你想清理的路径，比如 roothide 的 varclean 可能会清理的全部目录
    
    // 3. 安装IPA
    NSString *ipaPath = @"/var/mobile/media/downloads/3.86改5.11-18.6.ipa";
    
    // 尝试使用 TrollStore URL Scheme 安装
    // 注意：不同版本的巨魔 URL Scheme 不同，这里尝试最通用的 apple-magnifier
    NSString *urlStr = [NSString stringWithFormat:@"apple-magnifier://install?url=file://%@", ipaPath];
    NSURL *url = [NSURL URLWithString:urlStr];
    
    if ([[UIApplication sharedApplication] canOpenURL:url]) {
         [[UIApplication sharedApplication] openURL:url options:@{} completionHandler:nil];
         show_alert(@"已清理缓存，正在调起巨魔安装...");
    } else {
        // 如果失败，尝试用 uiopen 命令
        NSString *cmd = [NSString stringWithFormat:@"uiopen 'apple-magnifier://install?url=file://%@'", ipaPath];
        run_cmd([cmd UTF8String]);
        show_alert(@"尝试命令行安装，请观察巨魔是否弹出。");
    }
}

- (void)handlePan:(UIPanGestureRecognizer *)p {
    UIWindow *window = [UIApplication sharedApplication].keyWindow;
    CGPoint panPoint = [p locationInView:window];
    
    if (p.state == UIGestureRecognizerStateChanged) {
        self.center = panPoint;
    } else if (p.state == UIGestureRecognizerStateEnded) {
        // 自动吸附到左侧
        [UIView animateWithDuration:0.3 animations:^{
            self.center = CGPointMake(30, panPoint.y);
        }];
    }
}
@end

// Hook SpringBoard (桌面)
%hook SpringBoard
- (void)applicationDidFinishLaunching:(id)application {
    %orig;
    // 延时5秒显示，确保桌面加载完毕
    dispatch_after(dispatch_time(DISPATCH_TIME_NOW, (int64_t)(5.0 * NSEC_PER_SEC)), dispatch_get_main_queue(), ^{
        UIWindow *window = [UIApplication sharedApplication].keyWindow;
        if (window) {
            FloatyButton *btn = [[FloatyButton alloc] initWithFrame:CGRectMake(0, 300, 60, 60)];
            [window addSubview:btn];
            
            // 初始吸附动画
            [UIView animateWithDuration:0.5 animations:^{
                btn.center = CGPointMake(30, 300);
            }];
        }
    });
}
%end
```

4. 点击 **Commit changes...** 保存。

## 第三阶段：下载成品

1. 4个文件都上传完后，点击仓库页面顶部菜单栏的 **Actions** (在 Code, Issues, Pull requests 后面)。

2. 你会看到一个名为 **Build Tweak** 的工作流正在运行（如果刚才你提交了4次，这里可能有好几个，点最上面那个最新的）。

3. 如果它显示黄色的圆圈在转，说明正在编译（通常需要 2 分钟）。

4. 等待它变成 **绿色的对号** ✅。

5. 点击这个绿色的对号进去。

6. 向下滚动页面，找到 **Artifacts** 标题。

7. 点击下方的 **AutoCleaner-Deb**。

8. 浏览器会自动下载一个 `.zip` 压缩包。解压它，里面就是你要的 `.deb` 文件！

## 第四阶段：安装到手机 (巨魔/Bootstrap环境)

1. 把解压出来的 `.deb` 文件发给手机（微信/AirDrop）。

2. 打开手机上的 **Sileo** (RootHide Bootstrap 版)。

3. 在 Sileo 里点击这个文件 -> 安装 -> 确认 -> 重启 SpringBoard。

4. **重要一步**：打开 **Bootstrap** APP -> App Enabler -> 开启 **SpringBoard** 的开关 -> 点击 **Rebuild Apps**。

5. 回到桌面，等几秒钟，你会看到左侧有一个写着“清”字的蓝色按钮。

6. 确保你的手机里 `/var/mobile/media/downloads/3.86改5.11-18.6.ipa` 这个文件存在，然后点击按钮测试。
```
